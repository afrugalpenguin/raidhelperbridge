# RaidHelperBridge Addon MVP Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Get the WoW TBC addon loading and functional with import, CC whispers, group optimization, and raid invites — testable in-game with mock data.

**Architecture:** The addon uses raw WoW API with a shared namespace (`local addonName, addon = ...`) passed through all files via the TOC. No Ace3 mixin pattern — modules hang off the `addon` table directly. The Bridge (Next.js) generates `!RHB!<base64-deflate-json>` import strings that the addon parses.

**Tech Stack:** Lua 5.1 (WoW TBC 2.5.4 client), LibDeflate for decompression, Ace3 for addon lifecycle/events/timers/commands/comms, Next.js + TypeScript + pako for the Bridge.

---

## Current State Assessment

The codebase already has substantial code written — this is NOT a greenfield build. Here's what exists:

| File | Status | Notes |
|------|--------|-------|
| `RaidHelperBridge.toc` | Complete | Load order correct, references Ace3 libs |
| `Core.lua` | **Functional but NOT using Ace3** | Uses raw CreateFrame + OnEvent. Slash commands, saved vars, utility functions all work. |
| `Import.lua` | **Functional** | Base64 decoder, JSON parser, LibDeflate integration, import dialog UI all present. |
| `CCManager.lua` | **Functional** | Marker detection, mob type matching, whisper logic, cooldowns, event hooking. |
| `GroupManager.lua` | **Functional** | Buff provider matching, group calculation, SetRaidSubgroup integration. |
| `InviteManager.lua` | **Functional** | Queue-based invites with C_Timer throttling, ConvertToRaid, kick management. |
| `Data/CCAbilities.lua` | Complete | 14 CC types with mob types, durations, class mapping. |
| `Data/BuffProviders.lua` | Complete | ~30 TBC buffs with class/spec/benefit metadata. |
| `Data/MarkerInfo.lua` | Complete | Markers 1-8, class colors. |
| `UI/MainFrame.lua` | Minimal | Minimap button only. |
| `UI/ImportDialog.lua` | Stub | Comment says "see Import.lua" (dialog is there). |
| `UI/CCEditor.lua` | Stub | Placeholder comment only. |
| `UI/GroupEditor.lua` | Stub | Placeholder comment only. |
| `Bridge/lib/types.ts` | Complete | All TypeScript types defined. |
| `Bridge/lib/importGenerator.ts` | Complete | pako compress/decompress, CC resolution, payload builder. |
| `Bridge/package.json` | Complete | Dependencies listed (not installed). |

### Critical Problem: Ace3 Mismatch

The TOC lists Ace3 libraries but **Core.lua doesn't use them**. It uses raw `CreateFrame`/`SetScript("OnEvent")` instead of `AceAddon:NewAddon()`. This means:

1. The addon **will crash on load** if Ace3 libs aren't in `Libs/` (TOC tries to load them)
2. Even if libs are present, they're loaded but unused — wasted memory
3. Each module hooks OnEvent by overwriting `SetScript`, creating a fragile chain

### Decision Required: Ace3 or Raw API?

**Option A: Convert to Ace3 properly** — Rewrite Core.lua to use `AceAddon:NewAddon("RaidHelperBridge", "AceConsole-3.0", "AceEvent-3.0", "AceTimer-3.0")`. Modules become proper mixins. Requires downloading Ace3 libs.

**Option B: Remove Ace3, stay raw** — Strip Ace3 lines from TOC, keep the current raw API approach. Less code to manage, no external deps except LibDeflate. Simpler for a single-developer addon.

**Recommendation: Option B (remove Ace3, keep raw + LibDeflate only).** The existing code already works with raw API. Converting to Ace3 would mean rewriting every file for no functional benefit. LibDeflate is the only lib actually needed (for import string decompression).

---

## Task 1: Fix TOC and Remove Unused Ace3 Dependencies

**Files:**
- Modify: `Addon/RaidHelperBridge.toc`

**Step 1: Update TOC to remove Ace3 lib references**

Replace the Libraries section in `RaidHelperBridge.toc` with only LibDeflate:

```toc
## Interface: 20504
## Title: Raid Helper Bridge
## Notes: Bridges Discord Raid-Helper signups with in-game raid management
## Author: Mac
## Version: 1.0.0
## SavedVariables: RaidHelperBridgeDB
## SavedVariablesPerCharacter: RaidHelperBridgeCharDB

# Libraries
Libs\LibDeflate\LibDeflate.lua

# Data
Data\CCAbilities.lua
Data\BuffProviders.lua
Data\MarkerInfo.lua

# Core
Core.lua
Import.lua
CCManager.lua
GroupManager.lua
InviteManager.lua

# UI
UI\MainFrame.lua
```

Note: Removed `UI\ImportDialog.lua` (empty stub — dialog lives in Import.lua), `UI\CCEditor.lua`, and `UI\GroupEditor.lua` (empty stubs that would error or do nothing).

**Step 2: Verify no code references Ace3 APIs**

Check `Import.lua` line 7: `local LibDeflate = LibStub and LibStub:GetLibrary("LibDeflate", true)` — this uses LibStub which we're removing. Need to change to direct global reference since LibDeflate.lua registers itself as a global.

Update Import.lua line 7 to:
```lua
local LibDeflate = LibStub and LibStub:GetLibrary("LibDeflate", true) or _G.LibDeflate
```

Actually, LibDeflate can work standalone without LibStub. When loaded without LibStub present, it sets `_G.LibDeflate`. So the fix is:

```lua
local LibDeflate = _G.LibDeflate
```

But this won't work at file load time since LibDeflate.lua may not have executed yet (TOC load order). The safe approach: look it up lazily in `ParseImportString`.

**Step 3: Fix LibDeflate reference in Import.lua**

Remove the top-level LibDeflate variable. Instead, look it up at usage time:

```lua
-- In ParseImportString, replace the decompress block:
local LibDeflate = _G.LibDeflate
if LibDeflate then
    json = LibDeflate:DecompressDeflate(compressed)
else
    addon:Debug("LibDeflate not found, trying uncompressed")
    json = compressed
end
```

**Step 4: Commit**

```bash
git add Addon/RaidHelperBridge.toc Addon/Import.lua
git commit -m "fix: remove unused Ace3 deps, keep only LibDeflate"
```

---

## Task 2: Download LibDeflate

**Files:**
- Create: `Addon/Libs/LibDeflate/LibDeflate.lua`

**Step 1: Download LibDeflate**

LibDeflate for WoW is available at: https://github.com/SafeteeWoW/LibDeflate

Download `LibDeflate.lua` (single file) and place it in `Addon/Libs/LibDeflate/LibDeflate.lua`.

```bash
mkdir -p Addon/Libs/LibDeflate
curl -L https://raw.githubusercontent.com/SafeteeWoW/LibDeflate/master/LibDeflate.lua -o Addon/Libs/LibDeflate/LibDeflate.lua
```

If curl fails (Windows), manually download from the GitHub repo.

**Step 2: Verify LibDeflate loads standalone**

Check the top of the downloaded file — LibDeflate supports both LibStub and standalone mode. It should set `_G.LibDeflate` when LibStub is absent.

If it requires LibStub, we need to also include LibStub (single file). In that case, update TOC:

```toc
# Libraries
Libs\LibStub\LibStub.lua
Libs\LibDeflate\LibDeflate.lua
```

**Step 3: Commit**

```bash
git add Addon/Libs/
git commit -m "feat: add LibDeflate library for import string decompression"
```

---

## Task 3: Fix Event Handler Chain

**Problem:** CCManager.lua and InviteManager.lua both call `addon.frame:GetScript("OnEvent")` and then `SetScript("OnEvent", ...)` to chain their handlers. This is fragile — if load order changes, handlers break. Each overwrites the previous.

**Files:**
- Modify: `Addon/Core.lua`
- Modify: `Addon/CCManager.lua`
- Modify: `Addon/InviteManager.lua`

**Step 1: Add a central event dispatcher to Core.lua**

Add after the existing event handler in Core.lua (before the export line):

```lua
-- Central event dispatcher
-- Modules register handlers here instead of overwriting OnEvent
addon.eventHandlers = {}

function addon:RegisterModuleEvent(event, handler)
    if not addon.eventHandlers[event] then
        addon.eventHandlers[event] = {}
        addon.frame:RegisterEvent(event)
    end
    table.insert(addon.eventHandlers[event], handler)
end
```

Update the existing `SetScript("OnEvent")` in Core.lua to also dispatch to registered handlers:

```lua
RaidHelperBridge:SetScript("OnEvent", function(self, event, arg1)
    if event == "ADDON_LOADED" and arg1 == addonName then
        InitializeSavedVars()
        SLASH_RAIDHELPBRIDGE1 = "/rhb"
        SLASH_RAIDHELPBRIDGE2 = "/raidhelperbridge"
        SlashCmdList["RAIDHELPBRIDGE"] = SlashHandler
        addon:Print("Loaded. Type /rhb for commands.")
    elseif event == "PLAYER_LOGIN" then
        if addon.InitCCManager then addon:InitCCManager() end
        if addon.InitGroupManager then addon:InitGroupManager() end
        if addon.InitInviteManager then addon:InitInviteManager() end
    end

    -- Dispatch to module handlers
    local handlers = addon.eventHandlers[event]
    if handlers then
        for _, handler in ipairs(handlers) do
            handler(event, arg1)
        end
    end
end)
```

**Step 2: Refactor CCManager.lua to use central dispatcher**

Remove the `GetScript`/`SetScript` chain at the bottom of CCManager.lua (lines 169-182). Replace with:

```lua
-- Register event handlers through central dispatcher
function addon:InitCCManager()
    addon:RegisterModuleEvent("RAID_TARGET_UPDATE", OnRaidTargetUpdate)
    addon:RegisterModuleEvent("PLAYER_TARGET_CHANGED", OnTargetChanged)
    addon:RegisterModuleEvent("UPDATE_MOUSEOVER_UNIT", OnMouseover)
    addon:Debug("CC Manager initialized")
end
```

Also remove the `RegisterEvent` calls from the existing `InitCCManager` (lines 27-29) since `RegisterModuleEvent` handles that.

**Step 3: Refactor InviteManager.lua to use central dispatcher**

Remove the `GetScript`/`SetScript` chain at the bottom of InviteManager.lua (lines 238-247). Update `InitInviteManager`:

```lua
function addon:InitInviteManager()
    addon:RegisterModuleEvent("GROUP_ROSTER_UPDATE", function(event, ...)
        -- Could auto-check for new joins here
    end)
    addon:Debug("Invite Manager initialized")
end
```

**Step 4: Commit**

```bash
git add Addon/Core.lua Addon/CCManager.lua Addon/InviteManager.lua
git commit -m "refactor: central event dispatcher instead of fragile SetScript chain"
```

---

## Task 4: Add Missing Slash Commands

**Problem:** The slash handler in Core.lua doesn't cover all commands listed in IMPLEMENTATION.md. Missing: `callout`, `whisper` toggle, `cancel` (invites), `kickcheck`, `confirmkick`, `buffs`, `who`.

**Files:**
- Modify: `Addon/Core.lua`

**Step 1: Extend the SlashHandler**

Add cases for the missing commands the modules already support:

```lua
local function SlashHandler(msg)
    local args = {}
    for word in msg:gmatch("%S+") do
        table.insert(args, word:lower())
    end

    local cmd = args[1] or "help"

    if cmd == "import" then
        addon:ShowImportDialog()
    elseif cmd == "cc" then
        addon:ShowCCAssignments()
    elseif cmd == "callout" then
        local marker = tonumber(args[2])
        addon:CalloutCC(marker)
    elseif cmd == "whisper" then
        addon:ToggleAutoWhisper()
    elseif cmd == "groups" then
        addon:PreviewGroupLayout()
    elseif cmd == "buffs" then
        addon:ShowBuffSummary()
    elseif cmd == "invite" then
        addon:SendRaidInvites()
    elseif cmd == "cancel" then
        addon:CancelInvites()
    elseif cmd == "sort" then
        addon:ApplyGroupLayout()
    elseif cmd == "status" then
        addon:ShowStatus()
    elseif cmd == "who" then
        addon:WhoCheck()
    elseif cmd == "kickcheck" then
        addon:KickNonEventPlayers()
    elseif cmd == "confirmkick" then
        addon:ConfirmKick()
    elseif cmd == "debug" then
        addon.charDb.debugMode = not addon.charDb.debugMode
        addon:Print("Debug mode: " .. (addon.charDb.debugMode and "ON" or "OFF"))
    elseif cmd == "clear" then
        addon.charDb.currentEvent = nil
        addon:Print("Event data cleared.")
    else
        addon:Print("Commands:")
        addon:Print("  /rhb import    - Import event from Raid-Helper")
        addon:Print("  /rhb status    - Show current event status")
        addon:Print("  /rhb cc        - Show CC assignments")
        addon:Print("  /rhb callout # - Announce CC for marker # in raid")
        addon:Print("  /rhb whisper   - Toggle auto-whisper on/off")
        addon:Print("  /rhb groups    - Preview group layout")
        addon:Print("  /rhb buffs     - Show available raid buffs")
        addon:Print("  /rhb sort      - Apply group optimisation")
        addon:Print("  /rhb invite    - Send raid invites")
        addon:Print("  /rhb cancel    - Cancel pending invites")
        addon:Print("  /rhb who       - Check event players' raid status")
        addon:Print("  /rhb debug     - Toggle debug mode")
        addon:Print("  /rhb clear     - Clear current event data")
    end
end
```

**Step 2: Commit**

```bash
git add Addon/Core.lua
git commit -m "feat: add missing slash commands (callout, whisper, buffs, cancel, who, kickcheck)"
```

---

## Task 5: Generate Mock Import String for Testing

**Files:**
- Create: `Bridge/lib/mockData.ts`

**Step 1: Create mock data generator**

Create a file that generates a realistic TBC Karazhan raid import string for testing:

```typescript
import { ImportPayload, WowClass, RaidRole } from './types';
import { generateImportString } from './importGenerator';

const MOCK_PLAYERS: { name: string; class: WowClass; role: RaidRole; spec?: string }[] = [
    { name: 'Tankadin', class: 'PALADIN', role: 'tank', spec: 'protection' },
    { name: 'Beartank', class: 'DRUID', role: 'tank', spec: 'feral' },
    { name: 'Frostbolt', class: 'MAGE', role: 'rdps', spec: 'frost' },
    { name: 'Icyveins', class: 'MAGE', role: 'rdps', spec: 'frost' },
    { name: 'Dotmaster', class: 'WARLOCK', role: 'rdps', spec: 'affliction' },
    { name: 'Backstab', class: 'ROGUE', role: 'mdps', spec: 'combat' },
    { name: 'Windrunner', class: 'HUNTER', role: 'rdps', spec: 'beastmastery' },
    { name: 'Holybolt', class: 'PALADIN', role: 'healer', spec: 'holy' },
    { name: 'Treeheals', class: 'DRUID', role: 'healer', spec: 'restoration' },
    { name: 'Spiritlink', class: 'SHAMAN', role: 'healer', spec: 'restoration' },
];

export const MOCK_PAYLOAD: ImportPayload = {
    version: 1,
    eventId: 'mock-kara-001',
    eventName: 'Karazhan Thursday',
    eventTime: Math.floor(Date.now() / 1000) + 86400,
    players: MOCK_PLAYERS,
    ccAssignments: [
        {
            marker: 6, // Square
            assignments: [{ ccType: 'polymorph', playerName: 'Frostbolt' }],
        },
        {
            marker: 5, // Moon
            assignments: [{ ccType: 'polymorph', playerName: 'Icyveins' }],
        },
        {
            marker: 4, // Triangle
            assignments: [{ ccType: 'banish', playerName: 'Dotmaster' }],
        },
        {
            marker: 3, // Diamond
            assignments: [{ ccType: 'freezingtrap', playerName: 'Windrunner' }],
        },
    ],
};

export function getMockImportString(): string {
    return generateImportString(MOCK_PAYLOAD);
}
```

**Step 2: Add a script to print the mock string**

Create `Bridge/scripts/generate-mock.ts`:

```typescript
import { getMockImportString, MOCK_PAYLOAD } from '../lib/mockData';
import { generateImportSummary } from '../lib/importGenerator';

console.log('=== Mock Import String ===');
console.log(getMockImportString());
console.log('');
console.log('=== Summary ===');
console.log(generateImportSummary(MOCK_PAYLOAD));
```

Run with: `cd Bridge && npx tsx scripts/generate-mock.ts`

This produces an import string you can paste into the addon's import dialog.

**Step 3: Also create a hardcoded uncompressed test string in Lua**

Add to `Addon/Core.lua` (temporary, for testing without Bridge):

```lua
-- TEST ONLY: Generate a mock event for testing without Bridge
function addon:LoadMockEvent()
    addon.charDb.currentEvent = {
        version = 1,
        eventId = "mock-kara-001",
        eventName = "Karazhan Thursday (Mock)",
        eventTime = time() + 86400,
        players = {
            { name = "Tankadin", class = "PALADIN", role = "tank", spec = "protection" },
            { name = "Beartank", class = "DRUID", role = "tank", spec = "feral" },
            { name = "Frostbolt", class = "MAGE", role = "rdps", spec = "frost" },
            { name = "Icyveins", class = "MAGE", role = "rdps", spec = "frost" },
            { name = "Dotmaster", class = "WARLOCK", role = "rdps", spec = "affliction" },
            { name = "Backstab", class = "ROGUE", role = "mdps", spec = "combat" },
            { name = "Windrunner", class = "HUNTER", role = "rdps", spec = "beastmastery" },
            { name = "Holybolt", class = "PALADIN", role = "healer", spec = "holy" },
            { name = "Treeheals", class = "DRUID", role = "healer", spec = "restoration" },
            { name = "Spiritlink", class = "SHAMAN", role = "healer", spec = "restoration" },
        },
        ccAssignments = {
            { marker = 6, assignments = {{ ccType = "polymorph", playerName = "Frostbolt" }} },
            { marker = 5, assignments = {{ ccType = "polymorph", playerName = "Icyveins" }} },
            { marker = 4, assignments = {{ ccType = "banish", playerName = "Dotmaster" }} },
            { marker = 3, assignments = {{ ccType = "freezingtrap", playerName = "Windrunner" }} },
        },
    }
    addon:Print("Mock event loaded: Karazhan Thursday")
    addon:Print("Use /rhb status to see details")
end
```

Add `"mock"` to the slash handler:

```lua
elseif cmd == "mock" then
    addon:LoadMockEvent()
```

**Step 4: Commit**

```bash
git add Bridge/lib/mockData.ts Bridge/scripts/generate-mock.ts Addon/Core.lua
git commit -m "feat: add mock data for testing addon without Bridge"
```

---

## Task 6: Clean Up Stub Files

**Files:**
- Delete: `Addon/UI/ImportDialog.lua` (empty stub, dialog is in Import.lua)
- Delete: `Addon/UI/CCEditor.lua` (empty stub)
- Delete: `Addon/UI/GroupEditor.lua` (empty stub)

**Step 1: Delete the files**

```bash
rm Addon/UI/ImportDialog.lua Addon/UI/CCEditor.lua Addon/UI/GroupEditor.lua
```

TOC was already updated in Task 1 to not reference these.

**Step 2: Commit**

```bash
git add -A Addon/UI/
git commit -m "chore: remove empty UI stub files"
```

---

## Task 7: Install Bridge Dependencies and Verify Build

**Files:**
- Modify: `Bridge/package.json` (add tsx for scripts)

**Step 1: Install dependencies**

```bash
cd Bridge
npm install
```

**Step 2: Add tsx for running TypeScript scripts**

```bash
npm install --save-dev tsx
```

**Step 3: Generate mock import string**

```bash
npx tsx scripts/generate-mock.ts
```

Copy the output — this is the string you paste into the WoW addon's import dialog.

**Step 4: Verify build**

```bash
npm run build
```

**Step 5: Commit**

```bash
git add Bridge/package.json Bridge/package-lock.json
git commit -m "chore: install deps, add tsx for script running"
```

---

## Task 8: End-to-End Testing Checklist

This is manual testing in the WoW TBC client.

**Setup:**
1. Copy/symlink `Addon/` to `Interface/AddOns/RaidHelperBridge`
2. Ensure `Libs/LibDeflate/LibDeflate.lua` exists
3. Log in to WoW TBC

**Test sequence:**

| # | Command | Expected Result |
|---|---------|-----------------|
| 1 | `/rhb` | Shows help text with all commands |
| 2 | `/rhb mock` | "Mock event loaded: Karazhan Thursday" |
| 3 | `/rhb status` | Shows event name, time, 10 players, class breakdown |
| 4 | `/rhb cc` | Shows 4 CC assignments (Square/Moon/Triangle/Diamond) |
| 5 | `/rhb groups` | Shows proposed group layout with buff optimization |
| 6 | `/rhb buffs` | Shows available buffs grouped by benefit type |
| 7 | `/rhb debug` | "Debug mode: ON" |
| 8 | `/rhb import` | Opens paste dialog (test with Bridge-generated string) |
| 9 | `/rhb whisper` | "Auto-whisper: OFF" (toggle) |
| 10 | `/rhb clear` | "Event data cleared." |
| 11 | `/rhb status` | "No event loaded..." |

**If addon doesn't load:**
- Check `!BugGrabber`/`!BugSack` for errors
- Check WoW chat for "Raid Helper Bridge" load message
- Verify all files exist and TOC Interface matches client version

---

## Summary of Changes

| Task | What | Why |
|------|------|-----|
| 1 | Strip Ace3 from TOC, fix LibDeflate ref | Addon would crash trying to load missing Ace3 files |
| 2 | Download LibDeflate | Only external dependency actually needed |
| 3 | Central event dispatcher | Replace fragile OnEvent chain that breaks on load order changes |
| 4 | Wire up all slash commands | ~8 module functions exist but aren't reachable from `/rhb` |
| 5 | Mock data (TS + Lua) | Test the addon without needing Bridge running or API key |
| 6 | Delete empty stubs | Clean up files that do nothing |
| 7 | Install Bridge deps | Verify the TypeScript side builds and can generate import strings |
| 8 | Manual testing | Validate everything works end-to-end in WoW client |
